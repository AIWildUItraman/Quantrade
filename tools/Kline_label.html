<!-- å¢å¼ºåŠŸèƒ½ç‰ˆæœ¬ - é€‚é…æ–°æ•°æ®æ ¼å¼ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿æ•°æ®æ ‡æ³¨å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }

        .control-panel {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .upload-section {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }

        .file-name {
            color: #333;
            font-size: 14px;
            background: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
            font-size: 15px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #e68900 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        #chartContainer {
            width: 100%;
            height: 750px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .label-panel {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe8a3 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #ffc107;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .label-panel h3 {
            color: #856404;
            margin-bottom: 18px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .label-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .label-btn {
            padding: 18px 35px;
            font-size: 17px;
            font-weight: bold;
            border: 3px solid transparent;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .label-btn-0 {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            color: white;
        }

        .label-btn-0:hover {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
        }

        .label-btn-1 {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .label-btn-1:hover {
            background: linear-gradient(135deg, #da190b 0%, #c41c0b 100%);
        }

        .label-btn-2 {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
            color: white;
        }

        .label-btn-2:hover {
            background: linear-gradient(135deg, #0b7dda 0%, #0a6bc2 100%);
        }

        .label-btn.active {
            border-color: #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            transform: scale(1.05);
        }

        .info-text {
            color: #856404;
            font-size: 14px;
            line-height: 1.8;
            background: rgba(255,255,255,0.7);
            padding: 15px;
            border-radius: 8px;
        }

        .info-text p {
            margin-bottom: 8px;
        }

        .stats {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-item-label {
            color: #1565c0;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-item strong {
            font-size: 28px;
            color: #0d47a1;
            display: block;
            font-weight: 800;
        }

        .message {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        /* é”®ç›˜å¿«æ·é”®æç¤º */
        .keyboard-hint {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            color: #555;
        }

        .keyboard-hint kbd {
            background: #333;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 3px;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .format-info {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .format-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .format-info code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ Kçº¿æ•°æ®æ ‡æ³¨å·¥å…·</h1>
        <p class="subtitle">ä¸“ä¸šçš„Kçº¿æ•°æ®å¯è§†åŒ–ä¸æ ‡æ³¨ç³»ç»Ÿï¼ˆæ”¯æŒæ–°æ ¼å¼ï¼‰</p>
        
        <div class="control-panel">
            <div class="format-info">
                <h4>ğŸ“‹ æ”¯æŒçš„æ•°æ®æ ¼å¼</h4>
                <p>æ–°æ ¼å¼ï¼ˆæ¨èï¼‰ï¼š<code>time,open,high,low,close,volume,amount</code></p>
                <p>ç¤ºä¾‹ï¼š2024-01-01 08:00:00,0.00123,0.00125,0.00122,0.00124,1000000,1240.5</p>
            </div>

            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".csv">
                    <label for="fileInput" class="file-input-label">ğŸ“ ä¸Šä¼ CSVæ–‡ä»¶</label>
                </div>
                <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
            </div>

            <div class="input-section">
                <label for="csvInput">ğŸ’¡ æˆ–ç›´æ¥ç²˜è´´CSVæ•°æ®ï¼š</label>
                <textarea id="csvInput" placeholder="ç²˜è´´CSVæ•°æ®ï¼ŒåŒ…å«è¡¨å¤´...&#10;&#10;æ–°æ ¼å¼ç¤ºä¾‹ï¼š&#10;time,open,high,low,close,volume,amount&#10;2024-01-01 08:00:00,0.00123,0.00125,0.00122,0.00124,1000000,1240.5&#10;2024-01-01 09:00:00,0.00124,0.00126,0.00123,0.00125,1100000,1375.2"></textarea>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="loadDataBtn">ğŸ“Š åŠ è½½æ•°æ®</button>
                <button class="btn-success" id="exportBtn" disabled>ğŸ’¾ å¯¼å‡ºæ ‡æ³¨æ•°æ®</button>
                <button class="btn-warning" id="clearLabelsBtn" disabled>ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ ‡æ³¨</button>
                <button class="btn-info" id="undoBtn" disabled>â†¶ æ’¤é”€</button>
                <button class="btn-danger" id="resetBtn" disabled>ğŸ”„ é‡ç½®è§†å›¾</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ•°æ®åŠ è½½ä¸­...</p>
            </div>

            <div class="message" id="message"></div>
        </div>

        <div class="label-panel" id="labelPanel" style="display: none;">
            <h3>ğŸ·ï¸ æ ‡æ³¨æ¨¡å¼</h3>
            <div class="label-buttons">
                <button class="label-btn label-btn-0" data-label="0">0ï¸âƒ£ æ— æ ‡æ³¨</button>
                <button class="label-btn label-btn-1" data-label="1">1ï¸âƒ£ å³°å€¼ ğŸ”º</button>
                <button class="label-btn label-btn-2" data-label="2">2ï¸âƒ£ è°·å€¼ ğŸ”»</button>
            </div>
            <div class="info-text">
                <p><strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                <p>â€¢ é€‰æ‹©æ ‡æ³¨ç±»å‹ï¼ˆ0=æ— æ ‡æ³¨ï¼Œ1=å³°å€¼ï¼Œ2=è°·å€¼ï¼‰</p>
                <p>â€¢ ç›´æ¥ç‚¹å‡»Kçº¿èœ¡çƒ›å›¾è¿›è¡Œæ ‡æ³¨</p>
                <p>â€¢ å·²æ ‡æ³¨çš„Kçº¿ä¼šæ˜¾ç¤ºå¯¹åº”çš„æ ‡è®°ï¼ˆå³°å€¼ï¼šğŸ”ºï¼Œè°·å€¼ï¼šğŸ”»ï¼‰</p>
                <p>â€¢ å¯ä»¥é‡å¤ç‚¹å‡»åŒä¸€Kçº¿ä¿®æ”¹æ ‡æ³¨</p>
                <p>â€¢ å®Œæˆåç‚¹å‡»"å¯¼å‡ºæ ‡æ³¨æ•°æ®"ä¿å­˜ä¸ºCSVæ–‡ä»¶</p>
            </div>
            <div class="keyboard-hint">
                <strong>âŒ¨ï¸ å¿«æ·é”®ï¼š</strong>
                <kbd>0</kbd> é€‰æ‹©æ— æ ‡æ³¨ 
                <kbd>1</kbd> é€‰æ‹©å³°å€¼ 
                <kbd>2</kbd> é€‰æ‹©è°·å€¼ 
                <kbd>Ctrl+Z</kbd> æ’¤é”€ 
                <kbd>Ctrl+S</kbd> å¯¼å‡º
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <div id="chartContainer"></div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-item-label">ğŸ“Š æ€»æ•°æ®é‡</div>
                <strong id="totalCount">0</strong>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">ğŸ”º å³°å€¼æ ‡æ³¨</div>
                <strong id="peakCount" style="color: #f44336;">0</strong>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">ğŸ”» è°·å€¼æ ‡æ³¨</div>
                <strong id="valleyCount" style="color: #2196F3;">0</strong>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">âšª æœªæ ‡æ³¨</div>
                <strong id="unlabeledCount" style="color: #9e9e9e;">0</strong>
            </div>
            <div class="stat-item">
                <div class="stat-item-label">ğŸ“ˆ æ ‡æ³¨è¿›åº¦</div>
                <strong id="progressPercent" style="color: #4CAF50;">0%</strong>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let chart = null;
        let klineData = [];
        let currentLabel = '0';
        let labels = {};
        let history = []; // æ“ä½œå†å²ï¼Œç”¨äºæ’¤é”€

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            initEventListeners();
            initKeyboardShortcuts();
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            chart = echarts.init(document.getElementById('chartContainer'));
            
            const option = {
                animation: false,
                backgroundColor: '#ffffff',
                legend: {
                    bottom: 15,
                    left: 'center',
                    data: ['Kçº¿', 'æˆäº¤é‡'],
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    borderWidth: 1,
                    borderColor: '#ccc',
                    padding: 15,
                    textStyle: {
                        color: '#000',
                        fontSize: 13
                    },
                    position: function (pos, params, el, elRect, size) {
                        const obj = {top: 10};
                        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                        return obj;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    extraCssText: 'box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-radius: 8px;'
                },
                axisPointer: {
                    link: [{xAxisIndex: 'all'}],
                    label: {
                        backgroundColor: '#667eea'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        },
                        saveAsImage: {
                            title: 'ä¿å­˜ä¸ºå›¾ç‰‡',
                            pixelRatio: 2
                        }
                    },
                    right: 20,
                    top: 10
                },
                grid: [
                    {
                        left: '8%',
                        right: '6%',
                        top: '8%',
                        height: '52%'
                    },
                    {
                        left: '8%',
                        right: '6%',
                        top: '68%',
                        height: '18%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: [],
                        boundaryGap: true,
                        axisLine: {
                            onZero: false,
                            lineStyle: {
                                color: '#667eea'
                            }
                        },
                        splitLine: {show: false},
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: [],
                        boundaryGap: true,
                        axisLine: {
                            onZero: false,
                            lineStyle: {
                                color: '#667eea'
                            }
                        },
                        axisTick: {show: false},
                        splitLine: {show: false},
                        axisLabel: {show: false},
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#667eea'
                            }
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: {show: false},
                        axisLine: {show: false},
                        axisTick: {show: false},
                        splitLine: {show: false}
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100,
                        handleStyle: {
                            color: '#667eea'
                        },
                        dataBackground: {
                            areaStyle: {
                                color: '#e3f2fd'
                            },
                            lineStyle: {
                                color: '#2196F3'
                            }
                        }
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: [],
                        itemStyle: {
                            color: '#ef5350',
                            color0: '#26a69a',
                            borderColor: '#ef5350',
                            borderColor0: '#26a69a'
                        },
                        markPoint: {
                            symbol: 'pin',
                            symbolSize: 50,
                            label: {
                                fontSize: 16,
                                formatter: function (param) {
                                    return param.value;
                                }
                            },
                            data: [],
                            tooltip: {
                                formatter: function (param) {
                                    return param.name + '<br>' + (param.data.coord || '');
                                }
                            }
                        }
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: [],
                        itemStyle: {
                            color: function(params) {
                                const index = params.dataIndex;
                                if (index === 0) return '#26a69a';
                                const current = klineData[index];
                                const prev = klineData[index - 1];
                                return current.close >= prev.close ? '#ef5350' : '#26a69a';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);

            // ç›‘å¬å›¾è¡¨ç‚¹å‡»äº‹ä»¶
            chart.on('click', function(params) {
                if (params.componentType === 'series' && params.seriesName === 'Kçº¿') {
                    const dataIndex = params.dataIndex;
                    labelKline(dataIndex);
                }
            });
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('fileName').textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('csvInput').value = e.target.result;
                    };
                    reader.readAsText(file);
                }
            });

            // åŠ è½½æ•°æ®
            document.getElementById('loadDataBtn').addEventListener('click', loadData);

            // å¯¼å‡ºæ•°æ®
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // æ¸…é™¤æ ‡æ³¨
            document.getElementById('clearLabelsBtn').addEventListener('click', clearLabels);

            // æ’¤é”€
            document.getElementById('undoBtn').addEventListener('click', undo);

            // é‡ç½®è§†å›¾
            document.getElementById('resetBtn').addEventListener('click', function() {
                if (chart) {
                    chart.dispatchAction({
                        type: 'dataZoom',
                        start: 0,
                        end: 100
                    });
                    showMessage('è§†å›¾å·²é‡ç½®', 'success');
                }
            });

            // æ ‡æ³¨æŒ‰é’®
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectLabel(this.dataset.label);
                });
            });

            // é»˜è®¤é€‰ä¸­0
            selectLabel('0');
        }

        // åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // 0, 1, 2 é”®åˆ‡æ¢æ ‡æ³¨æ¨¡å¼
                if (e.key === '0' || e.key === '1' || e.key === '2') {
                    e.preventDefault();
                    selectLabel(e.key);
                }

                // Ctrl+Z æ’¤é”€
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }

                // Ctrl+S å¯¼å‡º
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (!document.getElementById('exportBtn').disabled) {
                        exportData();
                    }
                }
            });
        }

        // é€‰æ‹©æ ‡æ³¨ç±»å‹
        function selectLabel(label) {
            currentLabel = label;
            document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.label-btn[data-label="${label}"]`).classList.add('active');
        }

        // åŠ è½½æ•°æ® - é€‚é…æ–°æ ¼å¼
        function loadData() {
            const csvText = document.getElementById('csvInput').value.trim();
            if (!csvText) {
                showMessage('âŒ è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´CSVæ•°æ®ï¼', 'error');
                return;
            }

            document.getElementById('loading').classList.add('show');

            // ä½¿ç”¨setTimeoutè®©loadingåŠ¨ç”»æ˜¾ç¤ºå‡ºæ¥
            setTimeout(() => {
                try {
                    const parsed = Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true
                    });

                    if (parsed.errors.length > 0) {
                        showMessage('âŒ CSVè§£æé”™è¯¯ï¼š' + parsed.errors[0].message, 'error');
                        document.getElementById('loading').classList.remove('show');
                        return;
                    }

                    const data = parsed.data;
                    if (data.length === 0) {
                        showMessage('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼', 'error');
                        document.getElementById('loading').classList.remove('show');
                        return;
                    }

                    // è§£æKçº¿æ•°æ® - æ”¯æŒæ–°æ ¼å¼
                    klineData = data.map(row => {
                        // æ–°æ ¼å¼å­—æ®µæ˜ å°„
                        const time = row['time'] || row['Time'] || row['å¼€ç›˜æ—¶é—´'] || row['timestamp'] || row['date'];
                        const open = parseFloat(row['open'] || row['Open'] || row['å¼€ç›˜ä»·']);
                        const high = parseFloat(row['high'] || row['High'] || row['æœ€é«˜ä»·']);
                        const low = parseFloat(row['low'] || row['Low'] || row['æœ€ä½ä»·']);
                        const close = parseFloat(row['close'] || row['Close'] || row['æ”¶ç›˜ä»·']);
                        const volume = parseFloat(row['volume'] || row['Volume'] || row['æˆäº¤é‡']);
                        const amount = parseFloat(row['amount'] || row['Amount'] || row['æˆäº¤é¢'] || row['quote_volume'] || 0);

                        // æ•°æ®éªŒè¯
                        if (!time || isNaN(open) || isNaN(high) || isNaN(low) || isNaN(close) || isNaN(volume)) {
                            return null;
                        }

                        return {
                            time: time,
                            open: open,
                            high: high,
                            low: low,
                            close: close,
                            volume: volume,
                            amount: amount,
                            rawData: row
                        };
                    }).filter(item => item !== null); // è¿‡æ»¤æ— æ•ˆæ•°æ®

                    if (klineData.length === 0) {
                        showMessage('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„Kçº¿æ•°æ®ï¼è¯·æ£€æŸ¥æ•°æ®æ ¼å¼ã€‚', 'error');
                        document.getElementById('loading').classList.remove('show');
                        return;
                    }

                    // åˆå§‹åŒ–æ ‡æ³¨
                    labels = {};
                    history = [];
                    klineData.forEach((item, index) => {
                        // å¦‚æœåŸæ•°æ®ä¸­æœ‰labelåˆ—ï¼Œåˆ™è¯»å–
                        const existingLabel = item.rawData['label'] || item.rawData['Label'];
                        labels[index] = existingLabel ? String(existingLabel) : '0';
                    });

                    renderChart();
                    
                    document.getElementById('labelPanel').style.display = 'block';
                    document.getElementById('stats').style.display = 'grid';
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('clearLabelsBtn').disabled = false;
                    document.getElementById('resetBtn').disabled = false;

                    updateStats();
                    document.getElementById('loading').classList.remove('show');
                    showMessage(`âœ… æˆåŠŸåŠ è½½ ${klineData.length} æ¡æ•°æ®ï¼`, 'success');

                } catch (error) {
                    document.getElementById('loading').classList.remove('show');
                    showMessage('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
                    console.error(error);
                }
            }, 100);
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart() {
            const dates = klineData.map(item => item.time);
            const values = klineData.map(item => [item.open, item.close, item.low, item.high]);
            const volumes = klineData.map(item => item.volume);

            // ç”Ÿæˆæ ‡æ³¨ç‚¹
            const markPointData = [];
            Object.keys(labels).forEach(index => {
                const label = labels[index];
                if (label === '1') {
                    markPointData.push({
                        name: 'å³°',
                        value: 'ğŸ”º',
                        xAxis: parseInt(index),
                        yAxis: klineData[index].high,
                        itemStyle: {
                            color: '#f44336'
                        }
                    });
                } else if (label === '2') {
                    markPointData.push({
                        name: 'è°·',
                        value: 'ğŸ”»',
                        xAxis: parseInt(index),
                        yAxis: klineData[index].low,
                        itemStyle: {
                            color: '#2196F3'
                        }
                    });
                }
            });

            chart.setOption({
                xAxis: [
                    {data: dates},
                    {data: dates}
                ],
                series: [
                    {
                        data: values,
                        markPoint: {
                            data: markPointData
                        }
                    },
                    {
                        data: volumes
                    }
                ],
                tooltip: {
                    formatter: function(params) {
                        if (params.length === 0) return '';
                        
                        let result = '';
                        params.forEach(param => {
                            if (param.seriesName === 'Kçº¿') {
                                const index = param.dataIndex;
                                const data = klineData[index];
                                const label = labels[index];
                                const labelText = label === '1' ? 'å³°å€¼ ğŸ”º' : label === '2' ? 'è°·å€¼ ğŸ”»' : 'æ— æ ‡æ³¨';
                                const labelColor = label === '1' ? '#f44336' : label === '2' ? '#2196F3' : '#9e9e9e';
                                const change = ((data.close - data.open) / data.open * 100).toFixed(2);
                                const changeColor = change >= 0 ? '#ef5350' : '#26a69a';
                                
                                result += `<div style="font-weight: bold; margin-bottom: 10px; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px;">${data.time}</div>`;
                                result += `<div style="display: grid; grid-template-columns: 80px 1fr; gap: 8px; font-size: 13px;">`;
                                result += `<div style="color: #999;">å¼€ç›˜:</div><div style="font-weight: 600;">${data.open.toFixed(8)}</div>`;
                                result += `<div style="color: #999;">æ”¶ç›˜:</div><div style="font-weight: 600;">${data.close.toFixed(8)}</div>`;
                                result += `<div style="color: #999;">æœ€é«˜:</div><div style="font-weight: 600; color: #f44336;">${data.high.toFixed(8)}</div>`;
                                result += `<div style="color: #999;">æœ€ä½:</div><div style="font-weight: 600; color: #26a69a;">${data.low.toFixed(8)}</div>`;
                                result += `<div style="color: #999;">æ¶¨è·Œå¹…:</div><div style="font-weight: 600; color: ${changeColor};">${change}%</div>`;
                                result += `<div style="color: #999;">æˆäº¤é‡:</div><div style="font-weight: 600;">${data.volume.toLocaleString()}</div>`;
                                if (data.amount > 0) {
                                    result += `<div style="color: #999;">æˆäº¤é¢:</div><div style="font-weight: 600;">${data.amount.toFixed(2)}</div>`;
                                }
                                result += `</div>`;
                                result += `<div style="margin-top: 10px; padding: 6px 12px; background: ${labelColor}; color: white; border-radius: 5px; display: inline-block; font-weight: bold; font-size: 13px;">æ ‡æ³¨: ${labelText}</div>`;
                            }
                        });
                        
                        return result;
                    }
                }
            });
        }

        // æ ‡æ³¨Kçº¿
        function labelKline(index) {
            // ä¿å­˜å†å²è®°å½•
            history.push({
                index: index,
                oldLabel: labels[index]
            });
            
            if (history.length > 100) {
                history.shift(); // ä¿æŒå†å²è®°å½•ä¸è¶…è¿‡100æ¡
            }

            labels[index] = currentLabel;
            renderChart();
            updateStats();
            
            const labelText = currentLabel === '1' ? 'å³°å€¼ ğŸ”º' : currentLabel === '2' ? 'è°·å€¼ ğŸ”»' : 'æ— æ ‡æ³¨';
            showMessage(`âœ… å·²æ ‡æ³¨ç¬¬ ${index + 1} æ ¹Kçº¿ä¸ºï¼š${labelText}`, 'success');
            
            document.getElementById('undoBtn').disabled = false;
        }

        // æ’¤é”€æ“ä½œ
        function undo() {
            if (history.length === 0) {
                showMessage('âš ï¸ æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'error');
                return;
            }

            const lastAction = history.pop();
            labels[lastAction.index] = lastAction.oldLabel;
            renderChart();
            updateStats();
            showMessage('â†¶ å·²æ’¤é”€ä¸Šä¸€æ¬¡æ“ä½œ', 'success');

            if (history.length === 0) {
                document.getElementById('undoBtn').disabled = true;
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const total = Object.keys(labels).length;
            let peaks = 0, valleys = 0, unlabeled = 0;

            Object.values(labels).forEach(label => {
                if (label === '1') peaks++;
                else if (label === '2') valleys++;
                else unlabeled++;
            });

            const labeled = peaks + valleys;
            const progress = total > 0 ? ((labeled / total) * 100).toFixed(1) : 0;

            document.getElementById('totalCount').textContent = total.toLocaleString();
            document.getElementById('peakCount').textContent = peaks.toLocaleString();
            document.getElementById('valleyCount').textContent = valleys.toLocaleString();
            document.getElementById('unlabeledCount').textContent = unlabeled.toLocaleString();
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // å¯¼å‡ºæ•°æ® - ä¿æŒæ–°æ ¼å¼
        function exportData() {
            try {
                const exportData = klineData.map((item, index) => {
                    return {
                        time: item.time,
                        open: item.open,
                        high: item.high,
                        low: item.low,
                        close: item.close,
                        volume: item.volume,
                        amount: item.amount,
                        label: labels[index] || '0'
                    };
                });

                const csv = Papa.unparse(exportData, {
                    quotes: false,
                    quoteChar: '"',
                    delimiter: ","
                });

                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.setAttribute('href', url);
                link.setAttribute('download', `kline_labeled_${timestamp}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
            } catch (error) {
                showMessage('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                console.error(error);
            }
        }

        // æ¸…é™¤æ ‡æ³¨
        function clearLabels() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ ‡æ³¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                Object.keys(labels).forEach(key => {
                    labels[key] = '0';
                });
                history = [];
                renderChart();
                updateStats();
                document.getElementById('undoBtn').disabled = true;
                showMessage('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ ‡æ³¨ï¼', 'success');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type + ' show';
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });
    </script>
</body>
</html>
