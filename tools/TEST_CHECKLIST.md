# K线标注工具 - 功能测试清单

## 📋 测试准备

1. **启动测试服务器**
   ```bash
   cd /Users/mengxiaosen/worksapce/Quantrade/tools
   python3 -m http.server 8888
   ```

2. **在浏览器打开**
   ```
   http://localhost:8888/annotation_tool.html
   ```

3. **打开开发者工具**
   - Chrome/Edge: `F12` 或 `Cmd+Option+I` (Mac)
   - 切换到 Console 标签页

---

## ✅ 测试项目

### 1. 基础功能测试

#### 1.1 页面加载 ✓
- [ ] 页面正常显示
- [ ] 控制台显示 "✅ ECharts库加载成功，版本: x.x.x"
- [ ] 没有JavaScript错误

#### 1.2 CSV上传（首次标注）
- [ ] 点击"📁 选择CSV文件"
- [ ] 选择一个包含 timestamp,open,high,low,close,volume 的CSV文件
- [ ] 页面显示 "✅ 加载成功: X 根K线，生成 X 个窗口"
- [ ] 上方K线图正常显示
- [ ] 下方显示三个归一化K线图（上一张、当前、下一张）

---

### 2. 标注功能测试

#### 2.1 基本标注操作
- [ ] 点击"📈 上涨 (1)"按钮，图像边框变绿色
- [ ] 右上角显示"📈 上涨"标签
- [ ] 自动跳转到下一张
- [ ] 进度条更新
- [ ] 统计信息更新

#### 2.2 键盘快捷键
- [ ] 按键盘 `1` → 标注为上涨
- [ ] 按键盘 `2` → 标注为下跌
- [ ] 按键盘 `3` → 标注为波动
- [ ] 按键盘 `←` → 上一张
- [ ] 按键盘 `→` → 下一张

---

### 3. K线缩放保持测试 🔍

#### 3.1 缩放功能
- [ ] 在上方K线图上使用鼠标滚轮缩放
- [ ] 或拖动下方的滑块调整显示范围
- [ ] 控制台显示 "缩放状态已更新: {start: X, end: Y}"

#### 3.2 缩放保持测试
- [ ] 缩放K线图到某个特定范围（例如显示中间部分）
- [ ] 标注当前图像（点击上涨/下跌/波动）
- [ ] **验证**：K线图保持缩放比例，向左平移一个单位
- [ ] **不应该**：重置到显示全部数据

---

### 4. 导出功能测试

#### 4.1 保存窗口数据（原功能）
- [ ] 点击"💾 保存窗口数据 (S)"
- [ ] 下载 `annotated_xxx.csv` 文件
- [ ] 打开文件，验证格式正确（包含24根K线详细数据）

#### 4.2 导出标签CSV（新功能）✨
- [ ] 点击"📄 导出标签CSV"
- [ ] 下载 `labeled_xxx.csv` 文件
- [ ] 打开文件，验证：
  - [ ] 表头：`timestamp,open,high,low,close,volume,label`
  - [ ] 行数与原始CSV相同
  - [ ] label列中有标注的标签（up/down/fluctuation）
  - [ ] **窗口i的标签出现在第i+23行**（窗口最右侧K线）

#### 4.3 导出图像ZIP（新功能）✨
- [ ] 点击"🖼️ 导出图像ZIP"
- [ ] 控制台显示处理进度
- [ ] 下载 `kline_dataset_xxx.zip` 文件
- [ ] 解压ZIP文件，验证结构：
  ```
  kline_dataset/
  ├── images/
  │   ├── up/         ← 上涨类别图像
  │   ├── down/       ← 下跌类别图像
  │   └── fluctuation/ ← 波动类别图像
  ├── labels.csv      ← 标签文件
  └── README.md       ← 使用说明
  ```
- [ ] 打开图像文件，验证：
  - [ ] 图像尺寸：600x400
  - [ ] 包含24根K线
  - [ ] 右上角有标签标记（📈/📉/📊）
  - [ ] 边框颜色与标签对应
- [ ] 打开 `labels.csv`，验证：
  - [ ] 表头：`filename,label`
  - [ ] 路径格式：`images/up/xxx.png,up`
- [ ] 打开 `README.md`，验证：
  - [ ] 包含数据集统计信息
  - [ ] 包含PyTorch使用示例
  - [ ] 包含TensorFlow使用示例

---

### 5. 继续标注测试（新功能）✨

#### 5.1 导入已标注的CSV
- [ ] 使用刚才导出的 `labeled_xxx.csv` 文件
- [ ] 点击"📁 选择CSV文件"，选择该文件
- [ ] 页面显示 "✅ 加载成功 | 恢复了 X 个标注"
- [ ] **验证**：自动跳转到第一个未标注的窗口
- [ ] 已标注的图像显示对应的标签和边框颜色

#### 5.2 继续标注
- [ ] 从当前位置继续标注
- [ ] 再次导出 `labeled_xxx.csv`
- [ ] 重新导入，验证标注进度正确保存

---

### 6. 边界情况测试

#### 6.1 空数据测试
- [ ] 上传一个未标注的CSV
- [ ] 点击"📄 导出标签CSV" → 应该正常导出，label列全为空
- [ ] 点击"🖼️ 导出图像ZIP" → 应该提示"没有已标注的数据"

#### 6.2 全部标注测试
- [ ] 标注所有窗口
- [ ] 导入导出的CSV
- [ ] **验证**：定位到最后一个窗口
- [ ] 所有图像都有标签显示

#### 6.3 缩放边界测试
- [ ] 缩放到数据末尾（接近100%）
- [ ] 标注图像
- [ ] **验证**：缩放不会超出100%

---

## 🐛 已知问题检查

### 问题1：K线缩放重置
- **现象**：标注后K线图重置到显示全部数据
- **预期**：应该保持缩放比例，向左平移
- **检查**：控制台是否有"缩放状态已更新"日志

### 问题2：标签未恢复
- **现象**：导入已标注CSV后，标签未显示
- **预期**：应该显示已标注的标签和边框
- **检查**：控制台"包含label列: true"

### 问题3：图像导出失败
- **现象**：点击导出图像后无响应或报错
- **预期**：应该下载ZIP文件
- **检查**：控制台是否有"JSZip库未加载"错误

---

## 📊 性能测试

### 大数据量测试
- [ ] 上传超过1000根K线的CSV
- [ ] 验证加载速度（应该在5秒内完成）
- [ ] 标注100个窗口
- [ ] 导出图像ZIP（验证生成速度和文件大小）

---

## ✅ 测试完成标准

所有以下条件都满足：
1. ✓ 所有基础功能正常工作
2. ✓ K线缩放在标注后保持
3. ✓ 标签CSV可以恢复标注状态
4. ✓ 图像ZIP符合PyTorch ImageFolder格式
5. ✓ 标签在图像上正确显示
6. ✓ 没有JavaScript错误
7. ✓ 所有导出文件格式正确

---

## 🆘 常见问题排查

### Q1: ECharts/JSZip加载失败
**解决**：
1. 检查网络连接
2. 关闭浏览器的跟踪保护
3. 刷新页面
4. 尝试使用Chrome/Edge浏览器

### Q2: CSV解析失败
**解决**：
1. 检查CSV格式（必须包含 timestamp/time, open, high, low, close, volume）
2. 检查数据是否有无效值（NaN, 负数等）
3. 查看控制台错误信息

### Q3: 图像导出很慢
**解决**：
- 这是正常的，图像越多越慢
- 控制台会显示进度："已处理 X/Y 张图像..."
- 不要关闭页面，等待完成

---

## 📝 测试记录

**测试日期**：___________
**测试人员**：___________
**测试环境**：
- 浏览器：___________
- 操作系统：___________

**测试结果**：
- 通过项数：_____ / _____
- 失败项数：_____
- 问题描述：

_______________________________________________
_______________________________________________
_______________________________________________
